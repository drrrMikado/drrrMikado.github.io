<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"mikado.drrr.app","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="由于 LastPass 的政策调整：从 2021-03-16 开始，免费用户不在支持多平台了，只能手机和电脑端只能选择一个使用，所以就萌发了自建bitwarden。 架构选择：traefik+bitwarden_rs，选择 traefik 是为了需要添加路由就可以部署其他项目。">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Traefik自建服务">
<meta property="og:url" content="https://mikado.drrr.app/Deploy-Services-With-Traefik/index.html">
<meta property="og:site_name" content="Mikado&#39;s Blog">
<meta property="og:description" content="由于 LastPass 的政策调整：从 2021-03-16 开始，免费用户不在支持多平台了，只能手机和电脑端只能选择一个使用，所以就萌发了自建bitwarden。 架构选择：traefik+bitwarden_rs，选择 traefik 是为了需要添加路由就可以部署其他项目。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://mikado.drrr.app/images/Deploy-Services-With-Traefik/images-2019-08-16-68962095_p01.jpg">
<meta property="og:image" content="https://mikado.drrr.app/images/Deploy-Services-With-Traefik/Traefik.png">
<meta property="article:published_time" content="2021-03-07T07:51:42.000Z">
<meta property="article:modified_time" content="2021-03-07T08:08:36.184Z">
<meta property="article:author" content="Mikado">
<meta property="article:tag" content="Server">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mikado.drrr.app/images/Deploy-Services-With-Traefik/images-2019-08-16-68962095_p01.jpg">

<link rel="canonical" href="https://mikado.drrr.app/Deploy-Services-With-Traefik/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<script data-ad-client="ca-pub-7906388876935796" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <title>使用Traefik自建服务 | Mikado's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-162906864-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-162906864-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Mikado's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Mikado's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">19</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">22</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://mikado.drrr.app/Deploy-Services-With-Traefik/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Mikado">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mikado's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          使用Traefik自建服务
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-07 15:51:42" itemprop="dateCreated datePublished" datetime="2021-03-07T15:51:42+08:00">2021-03-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img data-src="/images/Deploy-Services-With-Traefik/images-2019-08-16-68962095_p01.jpg" alt="" /></p>
<p>由于 LastPass 的<a target="_blank" rel="noopener" href="https://blog.lastpass.com/2021/02/changes-to-lastpass-free/">政策</a>调整：从 2021-03-16 开始，免费用户不在支持多平台了，只能手机和电脑端只能选择一个使用，所以就萌发了自建bitwarden。</p>
<p>架构选择：traefik+bitwarden_rs，选择 traefik 是为了需要添加路由就可以部署其他项目。</p>
<a id="more"></a>
<h1 id="traefik"><a class="markdownIt-Anchor" href="#traefik"></a> Traefik</h1>
<h2 id="什么是traefik"><a class="markdownIt-Anchor" href="#什么是traefik"></a> 什么是Traefik</h2>
<p>摘自 <a target="_blank" rel="noopener" href="https://github.com/traefik/traefik">GitHub</a> 的介绍：</p>
<blockquote>
<p>Traefik (pronounced traffic) is a modern HTTP reverse proxy and load balancer that makes deploying microservices easy. Traefik integrates with your existing infrastructure components (Docker, Swarm mode, Kubernetes, Marathon, Consul, Etcd, Rancher, Amazon ECS, …) and configures itself automatically and dynamically. Pointing Traefik at your orchestrator should be the only configuration step you need.</p>
</blockquote>
<p>简单说，Traefik 是一个反向代理和负载均衡，另外也支持HTTPS和自动续证书。</p>
<p><img data-src="/images/Deploy-Services-With-Traefik/Traefik.png" alt="" /></p>
<p>后端服务支持 Docker、k8s 部署方式，方便管理。</p>
<h2 id="配置内容"><a class="markdownIt-Anchor" href="#配置内容"></a> 配置内容</h2>
<h3 id="docker-composeyml"><a class="markdownIt-Anchor" href="#docker-composeyml"></a> docker-compose.yml</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">traefik:</span></span><br><span class="line">    <span class="comment"># The official v2 Traefik docker image</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">traefik:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">traefik</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># The HTTP port</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">      <span class="comment"># The Web UI (enabled by --api.insecure=true)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">proxy</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CF_API_EMAIL=/run/secrets/CF_API_EMAIL</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CF_DNS_API_TOKEN=/run/secrets/CF_DNS_API_TOKEN</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># So that Traefik can listen to the Docker events</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./traefik.yml:/etc/traefik/traefik.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf:/etc/traefik/conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/logs</span></span><br><span class="line">    <span class="attr">secrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CF_DNS_API_TOKEN</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CF_API_EMAIL</span></span><br><span class="line"></span><br><span class="line"><span class="attr">secrets:</span></span><br><span class="line">  <span class="attr">CF_DNS_API_TOKEN:</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">./secrets/CF_DNS_API_TOKEN</span></span><br><span class="line">  <span class="attr">CF_API_EMAIL:</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">./secrets/CF_API_EMAIL</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">proxy:</span></span><br><span class="line">    <span class="attr">driver:</span></span><br><span class="line">      <span class="string">bridge</span></span><br></pre></td></tr></table></figure>
<p>这里就简单的配置端口、挂载目录、networks和设置secret</p>
<h3 id="traefikyml"><a class="markdownIt-Anchor" href="#traefikyml"></a> traefik.yml</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">sendAnonymousUsage:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">entryPoints:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">address:</span> <span class="string">:80</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">redirections:</span></span><br><span class="line">        <span class="attr">entryPoint:</span></span><br><span class="line">          <span class="attr">to:</span> <span class="string">websecure</span></span><br><span class="line">          <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">websecure:</span></span><br><span class="line">    <span class="attr">address:</span> <span class="string">:443</span></span><br><span class="line"></span><br><span class="line"><span class="attr">providers:</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">directory:</span> <span class="string">/etc/traefik/conf/</span></span><br><span class="line">    <span class="attr">watch:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">docker:</span></span><br><span class="line">    <span class="attr">exposedByDefault:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">api:</span></span><br><span class="line">  <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dashboard:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ping:</span></span><br><span class="line">  <span class="attr">entryPoint:</span> <span class="string">&quot;traefik&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">certificatesResolvers:</span></span><br><span class="line">  <span class="attr">myresolver:</span></span><br><span class="line">    <span class="attr">acme:</span></span><br><span class="line">      <span class="attr">email:</span> <span class="string">email@example.com</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">&#x27;/etc/traefik/conf/acme.json&#x27;</span></span><br><span class="line">      <span class="attr">dnsChallenge:</span></span><br><span class="line">        <span class="attr">provider:</span> <span class="string">cloudflare</span></span><br><span class="line">        <span class="attr">delayBeforeCheck:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">filePath:</span> <span class="string">&quot;/logs/traefik.log&quot;</span></span><br><span class="line"><span class="attr">accessLog:</span></span><br><span class="line">  <span class="attr">filePath:</span> <span class="string">&quot;/logs/access.log&quot;</span></span><br></pre></td></tr></table></figure>
<p>这里有几个点：</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://entryPoints.web">entryPoints.web</a> 这里设置了重定向到 websecure 的 endpoints。</li>
<li>provider 这里设置了配置方案为 file，并设置配置目录和自动监控目录下文件改动。</li>
<li>api配置，开启 insecure 和 dashboard。</li>
<li>certificatesResolvers 设置了证书相关配置。为了支持泛证书，这里改为 dnsChallenge，并把提供方改为 cloudflare，同时也需要在 docker-compose.yml 设置环境变量：<code>CF_API_EMAIL</code>、<code>CF_DNS_API_TOKEN</code>。以上两个缺一不可。 <code>CF_DNS_API_TOKEN</code> 需要区域DNS修改、区域读取和区域设置读取权限。区域选择最好全部区域，因为其他选项未测试过。</li>
</ol>
<h3 id="routersyml"><a class="markdownIt-Anchor" href="#routersyml"></a> routers.yml</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">routers:</span></span><br><span class="line">    <span class="attr">shorten:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">&quot;Host(`domain`) &amp;&amp; (Path(`/s`) || PathPrefix(`/s/`))&quot;</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">shorten</span></span><br><span class="line">      <span class="attr">tls:</span></span><br><span class="line">        <span class="attr">certResolver:</span> <span class="string">myresolver</span></span><br><span class="line">      <span class="attr">middlewares:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">shorten-stripPrefix</span></span><br><span class="line">    <span class="attr">bitwarden-ui:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">&quot;Host(`bitwarden.domain`)&quot;</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">bitwarden-ui</span></span><br><span class="line">      <span class="attr">tls:</span></span><br><span class="line">        <span class="attr">certResolver:</span> <span class="string">myresolver</span></span><br><span class="line">    <span class="attr">bitwarden-websocket:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">&quot;Host(`bitwarden.domain`) &amp;&amp; Path(`/notifications/hub`)&quot;</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">bitwarden-websocket</span></span><br><span class="line">      <span class="attr">tls:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">dashboard:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">&quot;Host(`traefik.domain`) &amp;&amp; PathPrefix(`/api`, `/dashboard`)&quot;</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">api@internal</span></span><br><span class="line">      <span class="attr">tls:</span></span><br><span class="line">        <span class="attr">certResolver:</span> <span class="string">myresolver</span></span><br><span class="line">      <span class="attr">middlewares:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">auth</span></span><br><span class="line">  <span class="attr">middlewares:</span></span><br><span class="line">    <span class="attr">shorten-stripPrefix:</span></span><br><span class="line">      <span class="attr">stripPrefix:</span></span><br><span class="line">        <span class="attr">prefixes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;/s&quot;</span></span><br><span class="line">    <span class="attr">auth:</span></span><br><span class="line">      <span class="attr">basicAuth:</span></span><br><span class="line">        <span class="attr">users:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;xxxx:$apr1$aaaaabb#bbbspHhHhHh4gtl39E89gc1&quot;</span></span><br><span class="line">  <span class="attr">services:</span></span><br><span class="line">    <span class="comment"># Define how to reach an existing service on our infrastructure</span></span><br><span class="line">    <span class="attr">shorten:</span></span><br><span class="line">      <span class="attr">loadBalancer:</span></span><br><span class="line">        <span class="attr">servers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://shorten</span></span><br><span class="line">    <span class="attr">bitwarden-ui:</span></span><br><span class="line">      <span class="attr">loadBalancer:</span></span><br><span class="line">        <span class="attr">servers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://bitwarden</span></span><br><span class="line">    <span class="attr">bitwarden-websocket:</span></span><br><span class="line">      <span class="attr">loadBalancer:</span></span><br><span class="line">        <span class="attr">servers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://bitwarden:3012</span></span><br></pre></td></tr></table></figure>
<p>这里就是配置路由、中间件和服务了。基本看配置名和配置内容就能大概理解要怎么设置了，但是这里要对两个选项再次说明下：</p>
<ol>
<li>tls.certResolver 这里设置的名称 <code>myresolver</code> 是 traefik.yml 中设置的名称</li>
<li>bitwarden提供了websocket，对外提供端口为3012，所以这里直接转发到 <a target="_blank" rel="noopener" href="http://bitwarden:3012">http://bitwarden:3012</a>。
<ul>
<li>吐槽</li>
</ul>
</li>
</ol>
<h1 id="bitwarden"><a class="markdownIt-Anchor" href="#bitwarden"></a> Bitwarden</h1>
<p>Bitwarden 是一个类似 1Password 和 LastPass 的开源密码管理软件，Bitwarden RS 是基于 Rust 语言的一个实现，更轻量一些，可能效率也会更高一点点，并且是完全兼容官方 App 的，比如各种浏览器扩展，手机 App 等。</p>
<p>由于官方Bitwarden官方镜像要求内存2G+，我这个小机器只有1G内存，所以采用了设置的Bitwarden_rs，采用rust编写。</p>
<h2 id="配置文件"><a class="markdownIt-Anchor" href="#配置文件"></a> 配置文件</h2>
<h3 id="docker-composeyml-2"><a class="markdownIt-Anchor" href="#docker-composeyml-2"></a> docker-compose.yml</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">bitwarden:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">bitwardenrs/server:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">bitwarden</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./bw-data:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/logs</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">WEBSOCKET_ENABLED:</span> <span class="string">&#x27;true&#x27;</span> <span class="comment"># Required to use websockets</span></span><br><span class="line">      <span class="attr">SIGNUPS_ALLOWED:</span> <span class="string">&#x27;false&#x27;</span>   <span class="comment"># set to false to disable signups</span></span><br><span class="line">      <span class="attr">LOG_FILE:</span> <span class="string">/logs/bitwarden.log</span></span><br><span class="line">      <span class="attr">LOG_LEVEL:</span> <span class="string">warn</span></span><br><span class="line">      <span class="attr">EXTENDED_LOGGING:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefik_proxy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">traefik_proxy:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>SIGNUPS_ALLOWED</code> 一开始要设置 <code>true</code> ，方便去注册账号。注册完之后，设置为 <code>false</code> 关闭注册。</li>
</ul>
<h1 id="shorten"><a class="markdownIt-Anchor" href="#shorten"></a> Shorten</h1>
<p>这个是个人的短链接服务，也使用 Traefik 反代到短链接服务。</p>
<h2 id="配置文件-2"><a class="markdownIt-Anchor" href="#配置文件-2"></a> 配置文件</h2>
<h3 id="docker-composeyml-3"><a class="markdownIt-Anchor" href="#docker-composeyml-3"></a> docker-compose.yml</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">shorten:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">shorten:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">shorten</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SHORTEN_DSN:</span> <span class="string">$&#123;SHORTEN_DSN:-&quot;user=&#x27;postgres&#x27;</span> <span class="string">password=&#x27;&#x27;</span> <span class="string">host=&#x27;db-host&#x27;</span> <span class="string">port=5432</span> <span class="string">dbname=&#x27;shorten&#x27;</span> <span class="string">sslmode=disable</span> <span class="string">options=&#x27;-c</span> <span class="string">statement_timeout=60000&#x27;&quot;&#125;</span></span><br><span class="line">      <span class="attr">SHORTEN_ADDR:</span> <span class="string">&quot;shorten:80&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefik_proxy</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="comment"># for access external database</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;db-host:host-gateway&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">traefik_proxy:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>这里要说的就是 <code>extra_hosts</code> 。因为数据库是在宿主机安装的，docker网络由于和宿主机隔离，可以查看 <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/43541732">Stack Overflow</a> 。</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Mikado
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://mikado.drrr.app/Deploy-Services-With-Traefik/" title="使用Traefik自建服务">https://mikado.drrr.app/Deploy-Services-With-Traefik/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Server/" rel="tag"># Server</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/PHP7-HashTable/" rel="prev" title="PHP7-HashTable源码阅读">
      <i class="fa fa-chevron-left"></i> PHP7-HashTable源码阅读
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#traefik"><span class="nav-number">1.</span> <span class="nav-text"> Traefik</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFtraefik"><span class="nav-number">1.1.</span> <span class="nav-text"> 什么是Traefik</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%86%85%E5%AE%B9"><span class="nav-number">1.2.</span> <span class="nav-text"> 配置内容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-composeyml"><span class="nav-number">1.2.1.</span> <span class="nav-text"> docker-compose.yml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#traefikyml"><span class="nav-number">1.2.2.</span> <span class="nav-text"> traefik.yml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#routersyml"><span class="nav-number">1.2.3.</span> <span class="nav-text"> routers.yml</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#bitwarden"><span class="nav-number">2.</span> <span class="nav-text"> Bitwarden</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.</span> <span class="nav-text"> 配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-composeyml-2"><span class="nav-number">2.1.1.</span> <span class="nav-text"> docker-compose.yml</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shorten"><span class="nav-number">3.</span> <span class="nav-text"> Shorten</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="nav-number">3.1.</span> <span class="nav-text"> 配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-composeyml-3"><span class="nav-number">3.1.1.</span> <span class="nav-text"> docker-compose.yml</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mikado"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Mikado</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/drrrMikado" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;drrrMikado" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/NoneL1ke" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;NoneL1ke" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mikado</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  













<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  

</body>
</html>
